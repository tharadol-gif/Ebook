<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Online Flipbook</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- StPageFlip -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip/dist/css/page-flip.css">
<script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #0f172a;
  overflow: hidden;
  font-family: system-ui, -apple-system;
}

/* Containers */
#book, #mobileView {
  width: 100vw;
  height: 100vh;
}

/* Mobile scroll */
#mobileView {
  display: none;
  overflow-y: auto;
  padding: 10px;
}
#mobileView canvas {
  width: 100%;
  margin-bottom: 16px;
  border-radius: 10px;
  box-shadow: 0 8px 25px rgba(0,0,0,.35);
}

/* Toolbar */
.toolbar {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  background: rgba(15,23,42,.9);
  backdrop-filter: blur(10px);
  padding: 10px 14px;
  border-radius: 999px;
  z-index: 999;
}

/* Buttons */
.toolbar button {
  border: none;
  background: linear-gradient(135deg,#38bdf8,#0ea5e9);
  color: #fff;
  font-size: 15px;
  padding: 10px 14px;
  border-radius: 999px;
  cursor: pointer;
}
.toolbar button:active {
  transform: scale(.95);
}

/* Slider bar (quick navigation) */
.sliderBar {
  position: fixed;
  bottom: 72px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  z-index: 1000;
  pointer-events: none;
}
.sliderBar .inner {
  width: min(900px, 95%);
  background: rgba(15,23,42,.9);
  padding: 8px 12px;
  border-radius: 999px;
  display: flex;
  gap: 10px;
  align-items: center;
  pointer-events: auto;
}
.sliderBar input[type="range"] {
  width: 100%;
}
.pageLabel {
  color: #fff;
  font-size: 13px;
  min-width: 60px;
  text-align: center;
}

/* Ensure mobile view has bottom padding so canvases are not hidden behind toolbar */
#mobileView { padding-bottom: 92px; }

/* Mobile UI */
@media (max-width: 768px) {
  body { overflow: auto; }
  #book { display: none; }
  #mobileView { display: block; }
  .toolbar {
    bottom: 10px;
    padding: 8px 12px;
  }
}
</style>
</head>

<body>

<div id="book"></div>
<div id="mobileView"></div>

<!-- Slider bar -->
<div class="sliderBar" id="sliderBar" style="display:none;">
  <div class="inner">
    <input id="pageSlider" type="range" min="1" max="1" value="1" />
    <div class="pageLabel" id="pageLabel">1/1</div>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <button onclick="prevPage()">‚óÄ</button>
  <button onclick="goHome()">‚åÇ</button>
  <button onclick="nextPage()">‚ñ∂</button>
  <button onclick="toggleFullscreen()">‚õ∂</button>
</div>

<script>
const pdfUrl = "book.pdf"; // üî¥ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
let pageFlip;
let isMobile = window.innerWidth <= 768;
let currentPage = 1;
let totalPages = 0;

/* Load PDF */
// Ensure PDF.js worker is set (required for CDN builds)
if (window.pdfjsLib && !pdfjsLib.GlobalWorkerOptions.workerSrc) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {

  /* ===== MOBILE MODE ===== */
  if (isMobile) {
    for (let i = 1; i <= pdf.numPages; i++) {
      pdf.getPage(i).then(page => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        page.render({ canvasContext: ctx, viewport }).promise
          .then(() => {
            document.getElementById("mobileView").appendChild(canvas);
          });
      });
    }
    return;
  }

  /* ===== DESKTOP MODE ===== */
  const targetWidth = 600; // ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ)
  const targetHeight = 850;

  pageFlip = new St.PageFlip(
    document.getElementById("book"),
    {
      width: targetWidth,
      height: targetHeight,
      size: "stretch",
      minWidth: 320,
      maxWidth: 4000,
      minHeight: 420,
      maxHeight: 4000,
      showCover: true,
      mobileScrollSupport: false
    }
  );

  const pagePromises = [];
  for (let i = 1; i <= pdf.numPages; i++) {
    pagePromises.push(
      pdf.getPage(i).then(page => {
        // render to an intermediate canvas at scale that fits target
        const origVP = page.getViewport({ scale: 1 });
        const scale = Math.min(targetWidth / origVP.width, targetHeight / origVP.height);
        const renderVP = page.getViewport({ scale });

        const DPR = Math.min(window.devicePixelRatio || 1, 1.5);
        const renderCanvas = document.createElement('canvas');
        renderCanvas.width = Math.ceil(renderVP.width * DPR);
        renderCanvas.height = Math.ceil(renderVP.height * DPR);
        const renderCtx = renderCanvas.getContext('2d');
        if (renderCtx) {
          renderCtx.imageSmoothingEnabled = true;
          try { renderCtx.imageSmoothingQuality = 'high'; } catch(e){}
        }
        renderCtx.setTransform(DPR,0,0,DPR,0,0);

        return page.render({ canvasContext: renderCtx, viewport: renderVP }).promise
          .then(() => {
            // final canvas with exact target dimensions (DPR-aware)
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = Math.ceil(targetWidth * DPR);
            finalCanvas.height = Math.ceil(targetHeight * DPR);
            const finalCtx = finalCanvas.getContext('2d');
            if (finalCtx) finalCtx.imageSmoothingEnabled = true;
            finalCtx.fillStyle = '#ffffff';
            finalCtx.fillRect(0,0,finalCanvas.width, finalCanvas.height);

            // draw renderCanvas centered into finalCanvas
            const drawW = renderCanvas.width;
            const drawH = renderCanvas.height;
            const offsetX = Math.round((finalCanvas.width - drawW) / 2);
            const offsetY = Math.round((finalCanvas.height - drawH) / 2);
            finalCtx.drawImage(renderCanvas, offsetX, offsetY, drawW, drawH);

            // CSS size will match logical target (PageFlip handles scaling)
            finalCanvas.style.width = targetWidth + 'px';
            finalCanvas.style.height = targetHeight + 'px';
            finalCanvas.style.willChange = 'transform';
            finalCanvas.style.transform = 'translateZ(0)';

            return finalCanvas;
          });
      })
    );
  }

  Promise.all(pagePromises).then(canvases => {
    const pageElements = canvases.map(canvas => {
      const pageEl = document.createElement('div');
      pageEl.className = 'pf-page';
      pageEl.style.width = targetWidth + 'px';
      pageEl.style.height = targetHeight + 'px';
      pageEl.appendChild(canvas);
      return pageEl;
    });

    pageFlip.loadFromHTML(pageElements);
    setTimeout(()=>{ try{ pageFlip.update(); }catch(e){} }, 60);
    setTimeout(()=>{ try{ pageFlip.update(); }catch(e){} }, 300);

    // setup slider
    totalPages = canvases.length;
    const slider = document.getElementById('pageSlider');
    const label = document.getElementById('pageLabel');
    const sliderBar = document.getElementById('sliderBar');
    if (slider && label) {
      slider.max = totalPages;
      slider.value = 1;
      label.textContent = `1/${totalPages}`;
      sliderBar.style.display = isMobile ? 'none' : 'flex';

      slider.addEventListener('input', (e) => {
        const p = parseInt(e.target.value,10) || 1;
        currentPage = p;
        label.textContent = `${p}/${totalPages}`;
        if (pageFlip) {
          pageFlip.turnToPage(p);
          try{ pageFlip.update(); }catch(e){}
        }
      });
    }
  });

});

/* Controls */
function nextPage() {
  if (!isMobile && pageFlip) {
    pageFlip.flipNext();
    if (currentPage < totalPages) currentPage++;
    updateSliderUI();
    try{ pageFlip.update(); }catch(e){}
  }
}
function prevPage() {
  if (!isMobile && pageFlip) {
    pageFlip.flipPrev();
    if (currentPage > 1) currentPage--;
    updateSliderUI();
    try{ pageFlip.update(); }catch(e){}
  }
}
function goHome() {
  if (!isMobile && pageFlip) {
    pageFlip.turnToPage(1);
    currentPage = 1;
    updateSliderUI();
    try{ pageFlip.update(); }catch(e){}
  }
}
function updateSliderUI() {
  const slider = document.getElementById('pageSlider');
  const label = document.getElementById('pageLabel');
  if (slider) slider.value = Math.min(Math.max(1, currentPage), totalPages || 1);
  if (label) label.textContent = `${slider ? slider.value : currentPage}/${totalPages || 0}`;
}

/* Fullscreen */
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}

/* Resize */
window.addEventListener("resize", () => {
  try{ if (pageFlip) pageFlip.update(); }catch(e){}
});
</script>

</body>
</html>
