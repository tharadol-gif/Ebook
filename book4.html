<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>E-Book Reader</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip/dist/css/page-flip.css">
<script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--vh:1vh;--ch:90px;--grad:linear-gradient(135deg,#667eea,#5b6dcd,#8b7fc7,#9ea4c7,#b5bcc9);--btn:linear-gradient(135deg,#ff6b6b,#ee5a6f,#c44569)}
html,body{height:100%;margin:0;padding:0;background:var(--grad);background-attachment:fixed;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow:hidden}
#bookContainer{width:100%;height:calc(var(--vh)*100 - var(--ch));position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;padding:30px 15px}
#bookContainer.zoomed{overflow:auto;cursor:grab;align-items:flex-start;padding-top:0}
#bookContainer.zoomed:active{cursor:grabbing}
#book{width:100%;max-width:1400px;height:100%;display:flex;align-items:center;justify-content:center;transform-origin:top center;transition:transform .25s cubic-bezier(.4,0,.2,1)}
#bookContainer.zoomed #book{margin:20px 0}
.pf-page{position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff;backface-visibility:hidden;box-shadow:0 15px 35px rgba(0,0,0,.25),0 8px 20px rgba(0,0,0,.2);border-radius:2px;user-select:none}
.pf-page canvas{width:100%;height:100%;object-fit:contain;display:block}
.canvas-wrapper{width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}
.page-loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#f8f9fa;z-index:5;color:#666;font-size:13px}
.page-loading.hidden{display:none}
.mini-spinner{width:20px;height:20px;border:2px solid #ddd;border-top-color:#555;border-radius:50%;animation:spin .8s linear infinite}
.controls-container{position:fixed;bottom:0;left:0;right:0;height:var(--ch);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:6px;z-index:1000;pointer-events:none;background:linear-gradient(to top,rgba(0,0,0,.3),transparent);backdrop-filter:blur(4px)}
.controls-container>*{pointer-events:auto}
.sliderBar{width:min(95%,1200px);background:rgba(255,255,255,.15);backdrop-filter:blur(16px);padding:5px 12px;border-radius:20px;display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.25);box-shadow:0 4px 20px rgba(0,0,0,.2)}
.page-info{display:flex;align-items:center;gap:5px;min-width:85px;font-size:13px;font-weight:600}
#pageInput{width:50px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);border-radius:6px;color:#fff;text-align:center;padding:3px 5px;font-size:13px;font-weight:600;outline:none}
#pageInput:focus{background:rgba(255,255,255,.3)}
#pageSlider{flex:1;height:5px;-webkit-appearance:none;background:rgba(255,255,255,.25);border-radius:10px;outline:none;cursor:pointer}
#pageSlider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.3)}
#pageSlider::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#fff;cursor:pointer;border:none;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.toolbar{display:flex;gap:5px;background:rgba(255,255,255,.15);backdrop-filter:blur(16px);padding:5px 9px;border-radius:20px;border:1px solid rgba(255,255,255,.25);box-shadow:0 4px 20px rgba(0,0,0,.2)}
.toolbar button{border:none;background:var(--btn);color:#fff;font-weight:600;padding:0;border-radius:50%;cursor:pointer;font-size:15px;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 3px 10px rgba(0,0,0,.25);transition:all .2s}
.toolbar button:hover{transform:translateY(-2px) scale(1.05)}
.toolbar button:active{transform:translateY(0) scale(.95)}
.toolbar button:disabled{opacity:.4;cursor:not-allowed}
.nav-arrow{position:fixed;top:50%;transform:translateY(-50%);width:50px;height:80px;background:var(--btn);border:none;color:#fff;font-size:28px;cursor:pointer;z-index:998;display:flex;align-items:center;justify-content:center;opacity:.7;transition:all .3s;box-shadow:0 4px 15px rgba(0,0,0,.3)}
.nav-arrow:hover{opacity:1;transform:translateY(-50%) scale(1.1)}
.nav-arrow:disabled{opacity:.2;cursor:not-allowed}
.nav-arrow.left{left:10px;border-radius:0 12px 12px 0}
.nav-arrow.right{right:10px;border-radius:12px 0 0 12px}
.zoom-indicator{position:fixed;top:20px;right:20px;background:rgba(0,0,0,.8);color:#fff;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;opacity:0;transition:all .3s;z-index:999;pointer-events:none}
.zoom-indicator.show{opacity:1}
.orientation-indicator{position:fixed;top:20px;left:20px;background:rgba(0,0,0,.8);color:#fff;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:600;z-index:999;pointer-events:none;display:flex;align-items:center;gap:6px}
#loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.4),rgba(0,0,0,.6));backdrop-filter:blur(10px);z-index:2000;color:#fff}
.loader-box{display:flex;flex-direction:column;align-items:center;gap:14px;background:rgba(255,255,255,.12);padding:28px 36px;border-radius:18px;border:1px solid rgba(255,255,255,.25)}
.spinner{width:44px;height:44px;border:3px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media (max-width:768px) and (orientation:portrait){
  :root{--ch:100px}
  #bookContainer{padding:10px 5px}
  .toolbar button{width:38px;height:38px;font-size:14px}
  .nav-arrow{width:45px;height:70px;font-size:22px}
  .nav-arrow.left{left:5px}
  .nav-arrow.right{right:5px}
}
</style>
</head>
<body>

<div id="bookContainer"><div id="book"></div></div>
<button class="nav-arrow left" id="navPrevBtn" style="display:none">‚óÄ</button>
<button class="nav-arrow right" id="navNextBtn" style="display:none">‚ñ∂</button>
<div class="zoom-indicator" id="zoomIndicator">100%</div>
<div class="orientation-indicator" id="orientationIndicator">
  <span id="orientIcon">üì±</span>
  <span id="orientText">Portrait</span>
</div>

<div id="loader">
  <div class="loader-box">
    <div class="spinner"></div>
    <div class="loader-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠...</div>
  </div>
</div>

<div class="controls-container" style="display:none" id="controls">
  <div class="sliderBar">
    <div class="page-info">
      <input type="number" id="pageInput" value="1" min="1"/>
      <span>/</span>
      <span id="totalPages">0</span>
    </div>
    <input id="pageSlider" type="range" min="1" max="1" value="1"/>
  </div>
  <div class="toolbar">
    <button id="firstBtn">‚á§</button>
    <button id="prevBtn">‚óÄ</button>
    <button id="nextBtn">‚ñ∂</button>
    <button id="zoomInBtn">+</button>
    <button id="zoomOutBtn">‚àí</button>
    <button id="fsBtn">‚õ∂</button>
  </div>
</div>

<script>
const CFG = {
  pdfUrl: 'book4.pdf',
  renderAhead: 2,
  maxDPR: 2,
  quality: 1.8,
  portrait: { width: 0.92, maxW: 700, targetW: 650 },
  landscape: { width: 0.85, maxW: 1400, targetW: 900 }
};

const $ = s => document.querySelector(s);
let pdf, flip, curPage = 1, total = 0, zoom = 1, tW = 0, tH = 0, isPort = false;
let panning = false, startX, startY, scrLeft, scrTop;
const dims = new Map(), rendered = new Map(), elems = [], queue = new Set();
let resizeT, zoomT, kbT = 0;

if (window.pdfjsLib) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

function detectOrient() {
  isPort = window.innerHeight > window.innerWidth;
  const ind = $('#orientationIndicator'), icon = $('#orientIcon'), txt = $('#orientText');
  if (isPort) {
    icon.textContent = 'üì±';
    txt.textContent = 'Portrait';
    ind.style.background = 'rgba(255,107,107,.9)';
  } else {
    icon.textContent = 'üìñ';
    txt.textContent = 'Landscape';
    ind.style.background = 'rgba(102,126,234,.9)';
  }
  setTimeout(() => ind.style.opacity = '0', 3000);
  return isPort;
}

function updateVh() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
updateVh();

function applyZoom() {
  $('#book').style.transform = `scale(${zoom})`;
  const cont = $('#bookContainer');
  if (zoom > 1) {
    cont.classList.add('zoomed');
    cont.addEventListener('mousedown', startPan);
    cont.addEventListener('mousemove', doPan);
    cont.addEventListener('mouseup', endPan);
    cont.addEventListener('touchstart', startPanTouch, { passive: false });
    cont.addEventListener('touchmove', doPanTouch, { passive: false });
    cont.addEventListener('touchend', endPan);
  } else {
    cont.classList.remove('zoomed');
    cont.scrollTop = cont.scrollLeft = 0;
  }
  showZoom();
  updateUI();
}

function startPan(e) {
  if (zoom <= 1) return;
  panning = true;
  const c = $('#bookContainer');
  startX = e.pageX - c.offsetLeft;
  startY = e.pageY - c.offsetTop;
  scrLeft = c.scrollLeft;
  scrTop = c.scrollTop;
}

function startPanTouch(e) {
  if (zoom <= 1 || e.touches.length !== 1) return;
  panning = true;
  const c = $('#bookContainer'), t = e.touches[0];
  startX = t.pageX - c.offsetLeft;
  startY = t.pageY - c.offsetTop;
  scrLeft = c.scrollLeft;
  scrTop = c.scrollTop;
}

function doPan(e) {
  if (!panning || zoom <= 1) return;
  e.preventDefault();
  const c = $('#bookContainer');
  c.scrollLeft = scrLeft - ((e.pageX - c.offsetLeft - startX) * 1.5);
  c.scrollTop = scrTop - ((e.pageY - c.offsetTop - startY) * 1.5);
}

function doPanTouch(e) {
  if (!panning || zoom <= 1 || e.touches.length !== 1) return;
  e.preventDefault();
  const c = $('#bookContainer'), t = e.touches[0];
  c.scrollLeft = scrLeft - ((t.pageX - c.offsetLeft - startX) * 1.5);
  c.scrollTop = scrTop - ((t.pageY - c.offsetTop - startY) * 1.5);
}

function endPan() {
  panning = false;
}

function showZoom() {
  const ind = $('#zoomIndicator');
  ind.textContent = `${Math.round(zoom * 100)}%`;
  ind.classList.add('show');
  clearTimeout(zoomT);
  zoomT = setTimeout(() => ind.classList.remove('show'), 1500);
}

function zoomIn() {
  const steps = [1, 1.25, 1.5, 1.75, 2, 2.5];
  const idx = steps.indexOf(zoom);
  if (idx < steps.length - 1) {
    zoom = steps[idx + 1];
    applyZoom();
  }
}

function zoomOut() {
  const steps = [1, 1.25, 1.5, 1.75, 2, 2.5];
  const idx = steps.indexOf(zoom);
  if (idx > 0) {
    zoom = steps[idx - 1];
    applyZoom();
  }
}

async function init() {
  try {
    $('#loader').style.display = 'flex';
    detectOrient();
    
    pdf = await pdfjsLib.getDocument(CFG.pdfUrl).promise;
    total = pdf.numPages;
    
    await calcDims();
    createFlip();
    createPages();
    flip.loadFromHTML(elems);
    
    $('#loader').style.display = 'none';
    $('#controls').style.display = 'flex';
    $('#navPrevBtn').style.display = 'flex';
    $('#navNextBtn').style.display = 'flex';
    $('#pageSlider').max = total;
    $('#pageInput').max = total;
    $('#totalPages').textContent = total;
    
    await renderPage(1);
    if (!isPort) await renderPage(2);
    
    flip.turnToPage(0);
    updateUI();
    setTimeout(() => updateVisible(0), 100);
    
  } catch (err) {
    $('#loader').querySelector('.loader-text').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF (book.pdf)';
    console.error(err);
  }
}

async function calcDims() {
  const pg = await pdf.getPage(1);
  const vp = pg.getViewport({ scale: 1 });
  const s = isPort ? CFG.portrait : CFG.landscape;
  const availW = Math.min(window.innerWidth * s.width, s.maxW);
  const availH = (window.innerHeight - 100) * 0.85;
  const asp = vp.width / vp.height;
  
  let w = availW, h = w / asp;
  if (h > availH) {
    h = availH;
    w = h * asp;
  }
  
  tW = Math.min(s.targetW, w);
  tH = tW / asp;
  
  for (let i = 1; i <= total; i++) {
    const p = await pdf.getPage(i);
    const v = p.getViewport({ scale: 1 });
    dims.set(i, { w: v.width, h: v.height, asp: v.width / v.height, rot: p.rotate || 0 });
  }
}

function createFlip() {
  const bookEl = $('#book');
  bookEl.innerHTML = '';
  
  flip = new St.PageFlip(bookEl, {
    width: tW,
    height: tH,
    size: 'stretch',
    minWidth: 250,
    maxWidth: 3000,
    minHeight: 180,
    maxHeight: 3000,
    showCover: true,
    usePortrait: isPort,
    swipeDistance: 50
  });
  
  flip.on('flip', e => {
    curPage = e.data + 1;
    updateVisible(e.data);
    setTimeout(updateUI, 100);
  });
}

function createPages() {
  elems.length = 0;
  for (let i = 1; i <= total; i++) {
    const el = document.createElement('div');
    el.className = 'pf-page';
    el.dataset.pageNum = i;
    el.innerHTML = `<div class="page-loading"><div class="mini-spinner"></div></div><div class="canvas-wrapper"></div>`;
    elems.push(el);
  }
}

async function renderPage(n) {
  if (n < 1 || n > total || rendered.has(n) || queue.has(n)) return;
  queue.add(n);
  
  try {
    const pg = await pdf.getPage(n);
    const dim = dims.get(n);
    let rotation = dim.rot;
    
    // Auto-correct rotation if page appears sideways
    if (rotation === 90 || rotation === 270) {
      rotation = 0;
    }
    
    const scale = (tW / dim.w) * CFG.quality;
    const dpr = Math.min(window.devicePixelRatio || 1, CFG.maxDPR);
    const vp = pg.getViewport({ scale: scale * dpr, rotation });
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    canvas.width = vp.width;
    canvas.height = vp.height;
    
    await pg.render({ canvasContext: ctx, viewport: vp }).promise;
    
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    
    const el = elems[n - 1];
    el.querySelector('.canvas-wrapper').innerHTML = '';
    el.querySelector('.canvas-wrapper').appendChild(canvas);
    el.querySelector('.page-loading').classList.add('hidden');
    
    rendered.set(n, canvas);
  } catch (err) {
    console.error(`Error page ${n}:`, err);
  } finally {
    queue.delete(n);
  }
}

function updateVisible(idx) {
  const pg = idx + 1;
  const toRender = new Set();
  
  if (isPort) {
    for (let i = 0; i <= CFG.renderAhead; i++) {
      const p = pg + i;
      if (p >= 1 && p <= total) toRender.add(p);
    }
  } else {
    const left = pg % 2 === 0 ? pg - 1 : pg;
    const right = left + 1;
    if (left >= 1 && left <= total) toRender.add(left);
    if (right >= 1 && right <= total) toRender.add(right);
    
    for (let i = 1; i <= CFG.renderAhead; i++) {
      const nL = left + (i * 2);
      const nR = nL + 1;
      if (nL >= 1 && nL <= total) toRender.add(nL);
      if (nR >= 1 && nR <= total) toRender.add(nR);
    }
  }
  
  toRender.forEach(p => {
    if (!rendered.has(p) && !queue.has(p)) renderPage(p);
  });
}

function updateUI() {
  $('#pageInput').value = curPage;
  $('#pageSlider').value = curPage;
  
  $('#prevBtn').disabled = $('#firstBtn').disabled = $('#navPrevBtn').disabled = curPage <= 1;
  $('#nextBtn').disabled = $('#navNextBtn').disabled = curPage >= total;
  $('#zoomInBtn').disabled = zoom >= 2.5;
  $('#zoomOutBtn').disabled = zoom <= 1;
}

function goPage(p) {
  curPage = Math.max(1, Math.min(total, parseInt(p) || 1));
  flip.turnToPage(curPage - 1);
  updateUI();
}

$('#pageInput').addEventListener('change', e => goPage(e.target.value));
$('#pageSlider').addEventListener('input', e => goPage(e.target.value));
$('#firstBtn').addEventListener('click', () => goPage(1));
$('#prevBtn').addEventListener('click', () => curPage > 1 && flip.flipPrev());
$('#nextBtn').addEventListener('click', () => curPage < total && flip.flipNext());
$('#navPrevBtn').addEventListener('click', () => curPage > 1 && flip.flipPrev());
$('#navNextBtn').addEventListener('click', () => curPage < total && flip.flipNext());
$('#zoomInBtn').addEventListener('click', zoomIn);
$('#zoomOutBtn').addEventListener('click', zoomOut);
$('#fsBtn').addEventListener('click', () => {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen?.();
  else document.exitFullscreen?.();
});

document.addEventListener('keydown', e => {
  if (Date.now() - kbT < 200) return;
  kbT = Date.now();
  if (e.key === 'ArrowRight') curPage < total && flip.flipNext();
  else if (e.key === 'ArrowLeft') curPage > 1 && flip.flipPrev();
  else if (e.key === 'Home') goPage(1);
  else if (e.key === 'End') goPage(total);
  else if (e.key === '+' || e.key === '=') zoomIn();
  else if (e.key === '-') zoomOut();
  else if (e.key === 'f' || e.key === 'F') $('#fsBtn').click();
});

window.addEventListener('resize', () => {
  clearTimeout(resizeT);
  updateVh();
  const was = isPort;
  detectOrient();
  
  if (was !== isPort) {
    rendered.clear();
    queue.clear();
    init();
  } else {
    resizeT = setTimeout(() => {
      calcDims().then(() => {
        rendered.clear();
        createFlip();
        createPages();
        flip.loadFromHTML(elems);
        flip.turnToPage(curPage - 1);
        updateVisible(curPage - 1);
      });
    }, 300);
  }
});

document.addEventListener('contextmenu', e => {
  if (e.target.closest('.pf-page, #book')) e.preventDefault();
});

init();
</script>
</body>
</html>
